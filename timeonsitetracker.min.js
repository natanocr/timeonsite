/**@preserve
 * Commercial License
 *
 * TimeOnSiteTracker.js - Measure your user's Time on site accurately.
 * 
 * Copyright (C) 2016  Saleem Khan
 *
 * License key: {your-license-key-here}
 *
 * This is copyrighted software and requires you buy commericial license
 * before using it. Replace {your-license-key-here} with the licence key 
 * that you buy before starting to use this software. 
 * 
 * visit https://github.com/saleemkce/timeonsite/master/LICENSE.md to learn more about 
 * license terms. 
 */
var TimeOnSiteTracker=function(a){this.varyingStartTime=new Date,this.pageEntryTime=(new Date).toISOString(),this.totalTimeSpent=0,this.returnInSeconds=!1,this.isTimeOnSiteAllowed=!0,this.callback=null,this.timeSpentArr=[],this.storeInLocalStorage=!1,this.storageSupported=!1,this.TOSDateKeysHolder="TimeOnSiteDateKeys",this.TOSDayKeyPrefix="TOS_",this.activity={},this.activity.activityStarted=!1,this.config=a,this.xhr=null,this.timeOnSite=0,this.TOSSessionKey=null,this.customData=null,this.TOSUserId="anonymous",this.anonymousTimerId=null,this.request={url:"",headers:[]},this.isRequestHeadersAvailable=!1,console.log("Time at page entry: "+this.varyingStartTime),this.initialize(this.config)};TimeOnSiteTracker.prototype.initialize=function(a){this.bindWindowUnload(),this.bindWindowFocus(),a&&a.trackBy&&"seconds"===a.trackBy.toLowerCase()&&(this.returnInSeconds=!0),a&&a.callback&&(this.callback=a.callback),this.initBlacklistUrlConfig(a),a&&a.trackHistoryChange&&a.trackHistoryChange===!0&&this.bindWindowHistory(),a&&a.request&&a.request.url&&(this.request.url=a.request.url,this.isURLValid(this.request.url),a.request.headers&&a.request.headers instanceof Array&&(this.isRequestHeadersAvailable=!0,this.request.headers=a.request.headers)),a&&a.request&&a.request.url&&null===this.callback&&(this.storeInLocalStorage=!0),"undefined"!=typeof Storage?(this.storageSupported=!0,this.processDataInLocalStorage()):console.info("Session/Local storage not supported by this browser."),this.storeInLocalStorage===!1&&null===this.callback&&console.warn("TOS data won't be available because neither callback nor local stroage option given!"),a&&a.request&&a.request.url&&this.callback&&console.warn("Both callback and local storage options given. Give either one!"),this.monitorUser(),this.monitorSession()},TimeOnSiteTracker.prototype.getTimeDiff=function(a,b){var c;return c=b-a},TimeOnSiteTracker.prototype.arrayAggregate=function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c];return b},TimeOnSiteTracker.prototype.isURLValid=function(a){var b=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;b.test(a)||console.error('Given URL is not in valid format : "'+a+'"')},TimeOnSiteTracker.prototype.createTOSId=function(){return Math.floor((new Date).valueOf()*Math.random())},TimeOnSiteTracker.prototype.millisecondToSecond=function(a){return a/1e3},TimeOnSiteTracker.prototype.secondToDuration=function(a){return parseInt(a/86400)+"d "+new Date(a%86400*1e3).toUTCString().replace(/.*(\d{2}):(\d{2}):(\d{2}).*/,"$1h $2m $3s")},TimeOnSiteTracker.prototype.getTOSSessionKey=function(){return this.TOSSessionKey},TimeOnSiteTracker.prototype.createTOSSessionKey=function(){var a=new Date,b=a.getMilliseconds()+"",c=++a+b+Math.floor(1e4*Math.random()+1);return c},TimeOnSiteTracker.prototype.startSession=function(a){if(a&&a.toString().length){if(!this.storageSupported)return void console.warn("TOS cound not initiate user session due to non-availability of Storage.");this.monitorSession(),this.processTOSData(),this.createNewSession();var b=0;this.TOSUserId=a,this.setCookie("TOSUserId",a,86400),this.setCookie("TOSSessionKey",this.TOSSessionKey,86400),this.setCookie("TOSSessionDuration",b,86400)}else console.warn("Please give proper userId to start TOS session.")},TimeOnSiteTracker.prototype.endSession=function(){this.monitorSession(),this.processTOSData(),this.removeCookie("TOSUserId"),this.removeCookie("TOSSessionKey"),this.removeCookie("TOSSessionDuration"),this.TOSUserId="anonymous",this.createNewSession("anonymous")},TimeOnSiteTracker.prototype.initBlacklistUrlConfig=function(a){a&&a.blacklistUrl&&(a.blacklistUrl instanceof Array||console.warn("blacklistUrl configuration must be of type array"),a.blacklistUrl instanceof Array&&a.blacklistUrl.length&&(this.checkBlacklistUrl(a.blacklistUrl)||(console.info("This page is blacklisted for tracking TOS!"),this.isTimeOnSiteAllowed=!1)))},TimeOnSiteTracker.prototype.monitorUser=function(){var a=this.getCookie("TOSUserId"),b=this.getCookie("TOSSessionKey");a&&a.length?(console.info("Authenticated user!!!"),this.TOSUserId=a):b&&!a?(console.info("Anonymous user!!!"),this.renewSession()):this.createNewSession("anonymous")},TimeOnSiteTracker.prototype.monitorSession=function(){var a,b=this.getCookie("TOSSessionDuration"),c=this.getCookie("TOSSessionKey"),d=0;console.log("AT monitorSession, key : "+c),c||alert("caution, sessionKey empty at : "+new Date),a=this.getTimeOnPage(),b=parseInt(b),d=a.timeOnPage+b,this.TOSSessionKey=c,this.setCookie("TOSSessionDuration",d,86400),this.timeOnSite=d},TimeOnSiteTracker.prototype.createNewSession=function(a){this.setCookie("TOSSessionDuration",0,86400),this.TOSSessionKey=this.createTOSSessionKey(),"anonymous"===a?(this.setCookie("TOSSessionKey",this.TOSSessionKey,15),this.renewSession()):(this.anonymousTimerId?clearInterval(this.anonymousTimerId):alert("Timer not found "+this.anonymousTimerId),this.setCookie("TOSSessionKey",this.TOSSessionKey,86400)),this.timeOnSite=0},TimeOnSiteTracker.prototype.renewSession=function(){var a=this;this.anonymousTimerId=setInterval(function(){console.log("cookie renewed at : "+new Date),a.setCookie("TOSSessionKey",a.TOSSessionKey,15)},1e3)},TimeOnSiteTracker.prototype.checkBlacklistUrl=function(a){for(var b=document.URL,c=0;c<a.length;c++)if(a[c]===b)return!1;return!0},TimeOnSiteTracker.prototype.getPageData=function(){var a={};return a.TOSId=this.createTOSId(),a.TOSSessionKey=this.TOSSessionKey,a.TOSUserId=this.TOSUserId,a.URL=document.URL,a.title=document.title,a},TimeOnSiteTracker.prototype.getTimeOnPage=function(){var a,b=new Date,c=0;return this.timeSpentArr.length&&(this.totalTimeSpent=this.arrayAggregate(this.timeSpentArr)),c=this.returnInSeconds?this.totalTimeSpent+this.getTimeDiff(this.varyingStartTime,b)/1e3:this.totalTimeSpent+this.getTimeDiff(this.varyingStartTime,b),a=this.getPageData(),a=this.mergeCustomData(a),a.entryTime=this.pageEntryTime,a.currentTime=(new Date).toISOString(),a.timeOnPage=Math.round(c),a.timeOnPageTrackedBy=this.returnInSeconds===!0?"second":"millisecond",a.timeOnSite=this.timeOnSite,a.timeOnPageByDuration=this.returnInSeconds===!0?this.secondToDuration(a.timeOnPage):this.secondToDuration(this.millisecondToSecond(a.timeOnPage)),a.timeOnSiteByDuration=this.returnInSeconds===!0?this.secondToDuration(a.timeOnSite):this.secondToDuration(this.millisecondToSecond(a.timeOnSite)),a.trackingType="tos",a},TimeOnSiteTracker.prototype.mergeCustomData=function(a){if(this.customData)for(var b in this.customData)a[b]=this.customData[b];return a},TimeOnSiteTracker.prototype.setCustomData=function(a){a&&Object.keys(a).length?this.customData=a:console.warn("custom data should be of type object!")},TimeOnSiteTracker.prototype.unsetCustomData=function(){this.customData=null},TimeOnSiteTracker.prototype.resetActivity=function(){this.activity.varyingStartTime=new Date,this.activity.totalTimeSpent=0,this.activity.totalTimeSpentArr=[]},TimeOnSiteTracker.prototype.startActivity=function(a){a&&Object.keys(a).length&&(this.startActivityDetails=a),this.resetActivity(),this.activity.activityStarted=!0,console.log("activity started at : "+this.activity.varyingStartTime)},TimeOnSiteTracker.prototype.endActivity=function(a,b){var c={};if(this.activity.activityStarted){console.log(this.activity.varyingStartTime);var d=new Date,e=0;this.activity.totalTimeSpentArr.length&&(this.activity.totalTimeSpent=this.arrayAggregate(this.activity.totalTimeSpentArr)),e=this.returnInSeconds?this.activity.totalTimeSpent+this.getTimeDiff(this.activity.varyingStartTime,d)/1e3:this.activity.totalTimeSpent+this.getTimeDiff(this.activity.varyingStartTime,d),console.log("totalSpent : "+this.activity.totalTimeSpent+" in array: "+this.getTimeDiff(this.activity.varyingStartTime,d)/1e3),c=this.getPageData(),c.activityStart=this.activity.varyingStartTime.toISOString(),c.activityEnd=(new Date).toISOString(),c.timeTaken=Math.round(e),c.timeTakenTrackedBy=this.returnInSeconds===!0?"second":"millisecond",c.timeTakenByDuration=this.returnInSeconds===!0?this.secondToDuration(c.timeTaken):this.secondToDuration(this.millisecondToSecond(c.timeTaken));for(var f in this.startActivityDetails)c[f]=this.startActivityDetails[f];if(a&&Object.keys(a).length)for(var f in a)c[f]=a[f];c.trackingType="activity",this.activity.activityStarted=!1,this.resetActivity(),console.log("activity ends at "+new Date),b||this.processActivityData(c)}else console.warn("Please start activity before finishing it!");return c},TimeOnSiteTracker.prototype.processActivityData=function(a){"function"==typeof this.callback?(a.realTimeTracking=!0,this.callback(a)):this.storeInLocalStorage&&this.saveToLocalStorage(a)},TimeOnSiteTracker.prototype.saveToLocalStorage=function(a){if(this.storageSupported){var b,c=new Date,d=this.TOSDayKeyPrefix+(c.getMonth()+1)+"_"+c.getDate()+"_"+c.getFullYear(),e=!1,f=this.TOSDateKeysHolder;if(b=localStorage.getItem(f)){for(var g=JSON.parse(b),h=0;h<g.length;h++)if(g[h]==d){e=!0;break}e||(g.push(d),localStorage.setItem(f,JSON.stringify(g)))}else b=[],b.push(d),localStorage.setItem(f,JSON.stringify(b));var i=localStorage.getItem(d);if(i){var j=JSON.parse(i);j.push(a),localStorage.setItem(d,JSON.stringify(j))}else{var k=[];k.push(a),localStorage.setItem(d,JSON.stringify(k))}}else console.warn("Local storage not supported for TOS tracking!")},TimeOnSiteTracker.prototype.processDataInLocalStorage=function(){var a=this.getDateKeys();if(a instanceof Array&&a.length){var b=(new Date,a[0]);console.log("this day key : "+b);var c=localStorage.getItem(b);if(c){var d=JSON.parse(c);d instanceof Array&&d.length&&this.sendData(b,d)}}},TimeOnSiteTracker.prototype.getDateKeys=function(){var a=[];if(this.storageSupported){var b=this.TOSDateKeysHolder,c=localStorage.getItem(b);c&&(a=JSON.parse(c))}return a},TimeOnSiteTracker.prototype.removeDateKey=function(a){var b=this.TOSDateKeysHolder,c=this.getDateKeys();if(this.storageSupported&&c instanceof Array&&c.length)for(var d=0;d<c.length;d++)c[d]==a&&(c.splice(d,1),console.log(c),localStorage.removeItem(a),localStorage.setItem(b,JSON.stringify(c)),c.length&&this.processDataInLocalStorage())},TimeOnSiteTracker.prototype.sendData=function(a,b){var c=this.request.url,d=JSON.stringify(b[0]),e=new Date,f=(this.TOSDayKeyPrefix+(e.getMonth()+1)+"_"+e.getDate()+"_"+e.getFullYear(),this);if(this.xhr=!1,window.XMLHttpRequest?this.xhr=new XMLHttpRequest:this.xhr=new ActiveXObject("Microsoft.XMLHTTP"),this.xhr.open("POST",c,!1),this.xhr.setRequestHeader("Content-Type","application/json;charset=UTF-8"),this.isRequestHeadersAvailable&&this.request.headers.length)for(var g=0;g<this.request.headers.length;g++){var h=this.request.headers[g];for(var i in h)this.xhr.setRequestHeader(i,h[i])}this.xhr.onreadystatechange=function(){4==f.xhr.readyState&&200==f.xhr.status&&"success"==f.xhr.responseText&&(b.shift(),console.log("itemData.length is : "+b.length),b.length?(console.log("calling next item to process"),setTimeout(function(){f.sendData(a,b)},500)):f.removeDateKey(a))},this.xhr.send(d)},TimeOnSiteTracker.prototype.cancelXMLHTTPRequest=function(){this.xhr&&"function"==typeof this.xhr.abort&&(console.log("$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$"),console.log(this.xhr),console.log("$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$"),this.xhr.abort())},TimeOnSiteTracker.prototype.bindWindowFocus=function(){var a,b,c,d=this;"undefined"!=typeof document.hidden?(a="hidden",c="visibilitychange",b="visibilityState"):"undefined"!=typeof document.mozHidden?(a="mozHidden",c="mozvisibilitychange",b="mozVisibilityState"):"undefined"!=typeof document.msHidden?(a="msHidden",c="msvisibilitychange",b="msVisibilityState"):"undefined"!=typeof document.webkitHidden&&(a="webkitHidden",c="webkitvisibilitychange",b="webkitVisibilityState"),"undefined"==typeof document.addEventListener||"undefined"==typeof a?console.log("Page visisbility API not supported which may result in less accuracy in TOS!"):document.addEventListener(c,function(){if("visible"==document[b])console.log("on visible"),d.varyingStartTime=new Date,d.totalTimeSpent=d.arrayAggregate(d.timeSpentArr),console.log("Time spent on site so far : "+d.totalTimeSpent),d.activity.activityStarted&&(d.activity.varyingStartTime=new Date,d.activity.totalTimeSpent=d.arrayAggregate(d.activity.totalTimeSpentArr),console.log("Time spent on ACTIVITY so far : "+d.activity.totalTimeSpent)),console.log("SECONDS "+d.returnInSeconds);else if("hidden"==document[b]){console.log("on Invisible");var a=new Date;console.log(d.timeSpentArr),d.returnInSeconds?d.timeSpentArr.push(d.getTimeDiff(d.varyingStartTime,a)/1e3):d.timeSpentArr.push(d.getTimeDiff(d.varyingStartTime,a)),d.activity.activityStarted&&(console.log(d.activity.totalTimeSpentArr),d.returnInSeconds?d.activity.totalTimeSpentArr.push(d.getTimeDiff(d.activity.varyingStartTime,a)/1e3):d.activity.totalTimeSpentArr.push(d.getTimeDiff(d.activity.varyingStartTime,a))),console.log("SECONDS "+d.returnInSeconds)}},!1)},TimeOnSiteTracker.prototype.setCookie=function(a,b,c){var d=new Date;d.setTime(d.getTime()+1e3*c);var e="expires="+d.toUTCString();document.cookie=a+"="+b+";"+e+";path=/"},TimeOnSiteTracker.prototype.getCookie=function(a){for(var b=a+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "==e.charAt(0);)e=e.substring(1);if(0==e.indexOf(b))return e.substring(b.length,e.length)}return""},TimeOnSiteTracker.prototype.removeCookie=function(a){this.getCookie(a)&&(document.cookie=a+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/")},TimeOnSiteTracker.prototype.bindWindowHistory=function(){var a=this;if(window.history&&window.history.pushState)!function(a){var b=a.pushState;a.pushState=function(c){return"function"==typeof a.onpushstate&&a.onpushstate({state:c}),b.apply(a,arguments)}}(window.history),window.onpopstate=history.onpushstate=function(b){setTimeout(function(){alert("URL changes via window history object!!!"),a.executeURLChangeCustoms()},100)};else{var b=function(){this.oldHash=window.location.hash;var b=this,c=function(){b.oldHash!=window.location.hash&&(b.oldHash=window.location.hash,alert("URL changes  via HANDLER!!!"),a.executeURLChangeCustoms())};setInterval(function(){c()},100)};new b}},TimeOnSiteTracker.prototype.executeURLChangeCustoms=function(){this.monitorSession(),this.processTOSData(),this.initBlacklistUrlConfig(this.config)},TimeOnSiteTracker.prototype.bindWindowUnload=function(){var a=this,b=window.attachEvent||window.addEventListener,c=window.attachEvent?"onbeforeunload":"beforeunload";b(c,function(b){"undefied"==typeof b&&(b=window.event),b&&(a.monitorSession(),a.processTOSData(),a.cancelXMLHTTPRequest())})},TimeOnSiteTracker.prototype.processTOSData=function(){console.log("Time at page exit: "+new Date);var a=this.getTimeOnPage();a.exitTime=(new Date).toISOString(),console.log("time so far : "+this.totalTimeSpent),this.isTimeOnSiteAllowed&&("function"==typeof this.callback?(a.realTimeTracking=!0,this.callback(a)):this.storeInLocalStorage&&this.saveToLocalStorage(a)),this.varyingStartTime=new Date,this.pageEntryTime=(new Date).toISOString(),this.totalTimeSpent=0,this.timeSpentArr=[],this.activity.activityStarted&&(this.activity.activityStarted=!1,this.resetActivity())};