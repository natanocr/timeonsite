/**@preserve
 * Commercial License
 *
 * TimeOnSiteTracker.js - Measure your user's Time on site accurately.
 * 
 * Copyright (C) 2016  Saleem Khan
 *
 * License key: {your-license-key-here}
 *
 * This is copyrighted software and requires you buy commericial license
 * before using it. Replace {your-license-key-here} with the licence key 
 * that you buy before starting to use this software. 
 * 
 * visit https://github.com/saleemkce/timeonsite/master/LICENSE.md to learn more about 
 * license terms. 
 */
var TimeOnSiteTracker=function(a){this.varyingStartTime=new Date,this.pageEntryTime=this.getDateTime(),this.activityStartTime=null,this.totalTimeSpent=0,this.returnInSeconds=!1,this.isTimeOnSiteAllowed=!0,this.callback=null,this.timeSpentArr=[],this.storeInLocalStorage=!1,this.storageSupported=!1,this.TOSDateKeysHolder="TimeOnSiteDateKeys",this.TOSDayKeyPrefix="TOS_",this.activity={},this.activity.activityStarted=!1,this.config=a,this.xhr=null,this.timeOnSite=0,this.TOSSessionKey=null,this.customData=null,this.TOSUserId="anonymous",this.anonymousTimerId=null,this.sessionStateChangeTimerId=null,this.fileIntegrityCode="ae4c20f53073125154d68d59c1818f8b",this.sessionValidity={anonymous:15,oneDayInSecs:86400,oneMonthInSeconds:2592e3},this.TOSCookie={path:null,domain:null,enforceSecure:!1},this.request={url:"",headers:[]},this.isRequestHeadersAvailable=!1,this.developerMode=!1,this.TOS_CONST={TOSSessionKey:"TOSSessionKey",TOSSessionDuration:"TOSSessionDuration",TOSUserId:"TOSUserId",TOSAnonSessionRefresh:"TOSAnonSessionRefresh",TOSIsCookieSupported:"TOSIsCookieSupported"},console.log("Time at page entry: "+this.varyingStartTime),this.initialize(this.config)};TimeOnSiteTracker.prototype.initialize=function(a){if(this.bindWindowUnload(),this.bindWindowFocus(),a&&a.trackBy&&"seconds"===a.trackBy.toLowerCase()&&(this.returnInSeconds=!0),a&&a.callback&&(this.callback=a.callback),this.initBlacklistUrlConfig(a),a&&a.trackHistoryChange&&a.trackHistoryChange===!0&&this.bindWindowHistory(),this.TOSCookie.customCookieString="",a&&a.TOSCookie?(a.TOSCookie.path?this.TOSCookie.customCookieString+="path="+this.validateCookieInput(a.TOSCookie.path)+";":this.TOSCookie.customCookieString+="path=/;",a.TOSCookie.domain&&(this.TOSCookie.customCookieString+="domain="+this.validateCookieInput(a.TOSCookie.domain)+";"),a.TOSCookie.enforceSecure&&"https:"===location.protocol&&(this.TOSCookie.customCookieString+="secure;")):this.TOSCookie.customCookieString+="path=/;",this.TOSCookie.customCookieString&&"path=/;"!=this.TOSCookie.customCookieString){var b=this.getMD5Hash(this.TOSCookie.customCookieString);this.TOS_CONST.TOSSessionKey=this.TOS_CONST.TOSSessionKey+"_"+b,this.TOS_CONST.TOSSessionDuration=this.TOS_CONST.TOSSessionDuration+"_"+b,this.TOS_CONST.TOSUserId=this.TOS_CONST.TOSUserId+"_"+b,this.TOS_CONST.TOSAnonSessionRefresh=this.TOS_CONST.TOSAnonSessionRefresh+"_"+b,this.TOS_CONST.TOSIsCookieSupported=this.TOS_CONST.TOSIsCookieSupported+"_"+b}if(a&&a.request&&a.request.url&&(this.request.url=a.request.url,this.isURLValid(this.request.url),a.request.headers&&a.request.headers instanceof Array&&(this.isRequestHeadersAvailable=!0,this.request.headers=a.request.headers)),a&&a.request&&a.request.url&&null===this.callback&&(this.storeInLocalStorage=!0),"undefined"!=typeof Storage?(this.storageSupported=!0,this.processDataInLocalStorage()):console.info("Session/Local storage not supported by this browser."),this.storeInLocalStorage===!1&&null===this.callback&&console.warn("TOS data won't be available because neither callback nor local stroage option given!"),a&&a.request&&a.request.url&&this.callback&&(this.storeInLocalStorage=!0,console.warn("Both callback and local storage options given. Local Storage takes precedence. Give either one!")),a&&a.developerMode&&(this.developerMode=!0,console.info("TOS cookie created with path/domain : "+this.TOSCookie.customCookieString)),this.checkCookieSupport(),this.monitorUser(),this.monitorSession(),this.monitorSessionStateChange(),this.fileValidation(),this.developerMode){var c=this;setInterval(function(){c.showProgress()},1e3)}},TimeOnSiteTracker.prototype.getTimeDiff=function(a,b){return b-a},TimeOnSiteTracker.prototype.validateCookieInput=function(a){return a&&a.length&&";"===a.substring(a.length-1)&&(a=a.substring(0,a.length-1)),a},TimeOnSiteTracker.prototype.arrayAggregate=function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c];return b},TimeOnSiteTracker.prototype.isURLValid=function(a){var b=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;b.test(a)||console.error('Given URL is not in valid format : "'+a+'"')},TimeOnSiteTracker.prototype.createTOSId=function(){return Math.floor((new Date).valueOf()*Math.random())},TimeOnSiteTracker.prototype.millisecondToSecond=function(a){return a/1e3},TimeOnSiteTracker.prototype.secondToDuration=function(a){return parseInt(a/86400)+"d "+new Date(a%86400*1e3).toUTCString().replace(/.*(\d{2}):(\d{2}):(\d{2}).*/,"$1h $2m $3s")},TimeOnSiteTracker.prototype.getDateTime=function(){return(new Date).toISOString().substr(0,23).replace("T"," ")},TimeOnSiteTracker.prototype.getTOSSessionKey=function(){return this.TOSSessionKey},TimeOnSiteTracker.prototype.createTOSSessionKey=function(){var a=new Date,b=a.getMilliseconds()+"",c=++a+b+Math.floor(1e4*Math.random()+1);return c},TimeOnSiteTracker.prototype.startSession=function(a){if(a&&a.toString().length){if(!this.storageSupported)return void console.warn("TOS cound not initiate user session due to non-availability of Storage.");this.monitorSession(),this.processTOSData(),this.setCookie(this.TOS_CONST.TOSAnonSessionRefresh,0,this.sessionValidity.oneDayInSecs),this.TOSUserId=a,this.setCookie(this.TOS_CONST.TOSUserId,a,this.sessionValidity.oneDayInSecs),this.createNewSession()}else console.warn("Please give proper userId to start TOS session.")},TimeOnSiteTracker.prototype.endSession=function(){this.monitorSession(),this.processTOSData(),this.removeCookie(this.TOS_CONST.TOSUserId),this.removeCookie(this.TOS_CONST.TOSSessionKey),this.removeCookie(this.TOS_CONST.TOSSessionDuration),this.TOSUserId="anonymous",this.createNewSession("anonymous")},TimeOnSiteTracker.prototype.showProgress=function(){var a=this.getTimeOnPage();console.log("TimeOnPage(TOP): "+a.timeOnPage+" "+a.timeOnPageTrackedBy)},TimeOnSiteTracker.prototype.checkCookieSupport=function(){var a=this;this.getCookie(this.TOS_CONST.TOSIsCookieSupported)||(this.setCookie(this.TOS_CONST.TOSIsCookieSupported,"yes",this.sessionValidity.oneMonthInSeconds),setTimeout(function(){a.getCookie(a.TOS_CONST.TOSIsCookieSupported)||(console.error("Setting cookie not supported by this browser. Exiting TOS..."),a.isTimeOnSiteAllowed=!1)},2e3))},TimeOnSiteTracker.prototype.extendSession=function(a){if("number"==typeof a&&this.getCookie(this.TOS_CONST.TOSUserId)){var b=parseInt(a),c=this.getCookie(this.TOS_CONST.TOSSessionDuration);c=c?parseInt(c):0,this.setCookie(this.TOS_CONST.TOSUserId,this.TOSUserId,b),this.setCookie(this.TOS_CONST.TOSSessionKey,this.TOSSessionKey,b),this.setCookie(this.TOS_CONST.TOSSessionDuration,c,b),this.setCookie(this.TOS_CONST.TOSAnonSessionRefresh,0,b);var d=new Date;d.setTime(d.getTime()+1e3*b),console.info("Session extended till "+new Date(d))}else console.warn("Either anonymous session detected or given input is not a number!")},TimeOnSiteTracker.prototype.initBlacklistUrlConfig=function(a){a&&a.blacklistUrl&&(a.blacklistUrl instanceof Array||console.warn("blacklistUrl configuration must be of type array"),a.blacklistUrl instanceof Array&&a.blacklistUrl.length&&(this.checkBlacklistUrl(a.blacklistUrl)||(console.info("This page is blacklisted for tracking TOS!"),this.isTimeOnSiteAllowed=!1)))},TimeOnSiteTracker.prototype.monitorUser=function(){var a=this.getCookie(this.TOS_CONST.TOSUserId),b=this.getCookie(this.TOS_CONST.TOSSessionKey);a&&a.length?(this.TOSSessionKey=b,this.TOSUserId=a,console.info("Authenticated user. TOSSessionKey: "+this.TOSSessionKey+" & TOSUserId: "+this.TOSUserId)):b&&!a?(console.info("Anonymous user. TOSSessionKey: "+b),this.TOSSessionKey=b,this.renewSession()):this.createNewSession("anonymous")},TimeOnSiteTracker.prototype.monitorSession=function(){var a,b=this.getCookie(this.TOS_CONST.TOSSessionDuration),c=this.getCookie(this.TOS_CONST.TOSSessionKey),d=0;console.log("AT monitorSession, key : "+c),c||alert("caution, sessionKey empty at : "+new Date),a=this.getTimeOnPage(),b=parseInt(b),d=a.timeOnPage+b,this.TOSSessionKey=c,this.setCookie(this.TOS_CONST.TOSSessionDuration,d,this.sessionValidity.oneDayInSecs),this.timeOnSite=d},TimeOnSiteTracker.prototype.createNewSession=function(a){this.setCookie(this.TOS_CONST.TOSSessionDuration,0,this.sessionValidity.oneDayInSecs),this.TOSSessionKey=this.createTOSSessionKey(),"anonymous"===a?(this.setCookie(this.TOS_CONST.TOSSessionKey,this.TOSSessionKey,this.sessionValidity.anonymous),this.setCookie(this.TOS_CONST.TOSAnonSessionRefresh,1,this.sessionValidity.oneDayInSecs),this.renewSession()):(this.anonymousTimerId&&(clearInterval(this.anonymousTimerId),console.info("Timer cleared "+this.anonymousTimerId)),this.setCookie(this.TOS_CONST.TOSSessionKey,this.TOSSessionKey,this.sessionValidity.oneDayInSecs)),this.timeOnSite=0},TimeOnSiteTracker.prototype.renewSession=function(){var a,b=this;this.anonymousTimerId=setInterval(function(){a=b.getCookie(b.TOS_CONST.TOSAnonSessionRefresh),1==a&&(b.setCookie(b.TOS_CONST.TOSSessionKey,b.TOSSessionKey,b.sessionValidity.anonymous),b.developerMode&&console.log("Session renewed at : "+new Date))},1e3)},TimeOnSiteTracker.prototype.monitorSessionStateChange=function(){var a,b,c=this;this.sessionStateChangeTimerId=setInterval(function(){a=c.getCookie(c.TOS_CONST.TOSSessionKey),b=c.getCookie(c.TOS_CONST.TOSUserId),console.error("old : ",c.TOSSessionKey,c.TOSUserId),a&&(c.TOSSessionKey=a),b?c.TOSUserId=b:c.TOSUserId="anonymous",console.error("new : ",c.TOSSessionKey,c.TOSUserId)},1500)},TimeOnSiteTracker.prototype.checkBlacklistUrl=function(a){for(var b=document.URL,c=0;c<a.length;c++)if(a[c]===b)return!1;return!0},TimeOnSiteTracker.prototype.getPageData=function(){var a={};return a.TOSId=this.createTOSId(),a.TOSSessionKey=this.TOSSessionKey,a.TOSUserId=this.TOSUserId,a.URL=document.URL,a.title=document.title,a},TimeOnSiteTracker.prototype.getTimeOnPage=function(){var a,b=new Date,c=0;return this.timeSpentArr.length&&(this.totalTimeSpent=this.arrayAggregate(this.timeSpentArr)),c=this.returnInSeconds?this.totalTimeSpent+this.getTimeDiff(this.varyingStartTime,b)/1e3:this.totalTimeSpent+this.getTimeDiff(this.varyingStartTime,b),a=this.getPageData(),a=this.mergeCustomData(a),a.entryTime=this.pageEntryTime,a.currentTime=this.getDateTime(),a.timeOnPage=Math.round(c),a.timeOnPageTrackedBy=this.returnInSeconds===!0?"second":"millisecond",a.timeOnSite=this.timeOnSite,a.timeOnPageByDuration=this.returnInSeconds===!0?this.secondToDuration(a.timeOnPage):this.secondToDuration(this.millisecondToSecond(a.timeOnPage)),a.timeOnSiteByDuration=this.returnInSeconds===!0?this.secondToDuration(a.timeOnSite):this.secondToDuration(this.millisecondToSecond(a.timeOnSite)),a.trackingType="tos",a},TimeOnSiteTracker.prototype.mergeCustomData=function(a){if(this.customData)for(var b in this.customData)a[b]=this.customData[b];return a},TimeOnSiteTracker.prototype.setCustomData=function(a){a&&Object.keys(a).length?this.customData=a:console.warn("custom data should be of type object!")},TimeOnSiteTracker.prototype.unsetCustomData=function(){this.customData=null},TimeOnSiteTracker.prototype.getMD5Hash=function(a){function b(a,b){return a<<b|a>>>32-b}function c(a,b){var c,d,e,f,g;return e=2147483648&a,f=2147483648&b,c=1073741824&a,d=1073741824&b,g=(1073741823&a)+(1073741823&b),c&d?2147483648^g^e^f:c|d?1073741824&g?3221225472^g^e^f:1073741824^g^e^f:g^e^f}function d(a,b,c){return a&b|~a&c}function e(a,b,c){return a&c|b&~c}function f(a,b,c){return a^b^c}function g(a,b,c){return b^(a|~c)}function h(a,e,f,g,h,i,j){return a=c(a,c(c(d(e,f,g),h),j)),c(b(a,i),e)}function i(a,d,f,g,h,i,j){return a=c(a,c(c(e(d,f,g),h),j)),c(b(a,i),d)}function j(a,d,e,g,h,i,j){return a=c(a,c(c(f(d,e,g),h),j)),c(b(a,i),d)}function k(a,d,e,f,h,i,j){return a=c(a,c(c(g(d,e,f),h),j)),c(b(a,i),d)}function l(a){for(var b,c=a.length,d=c+8,e=(d-d%64)/64,f=16*(e+1),g=Array(f-1),h=0,i=0;i<c;)b=(i-i%4)/4,h=i%4*8,g[b]=g[b]|a.charCodeAt(i)<<h,i++;return b=(i-i%4)/4,h=i%4*8,g[b]=g[b]|128<<h,g[f-2]=c<<3,g[f-1]=c>>>29,g}function m(a){var b,c,d="",e="";for(c=0;c<=3;c++)b=a>>>8*c&255,e="0"+b.toString(16),d+=e.substr(e.length-2,2);return d}function n(a){a=a.replace(/rn/g,"n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);d<128?b+=String.fromCharCode(d):d>127&&d<2048?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b}var o,p,q,r,s,t,u,v,w,x=Array(),y=7,z=12,A=17,B=22,C=5,D=9,E=14,F=20,G=4,H=11,I=16,J=23,K=6,L=10,M=15,N=21;for(a=n(a),x=l(a),t=1732584193,u=4023233417,v=2562383102,w=271733878,o=0;o<x.length;o+=16)p=t,q=u,r=v,s=w,t=h(t,u,v,w,x[o+0],y,3614090360),w=h(w,t,u,v,x[o+1],z,3905402710),v=h(v,w,t,u,x[o+2],A,606105819),u=h(u,v,w,t,x[o+3],B,3250441966),t=h(t,u,v,w,x[o+4],y,4118548399),w=h(w,t,u,v,x[o+5],z,1200080426),v=h(v,w,t,u,x[o+6],A,2821735955),u=h(u,v,w,t,x[o+7],B,4249261313),t=h(t,u,v,w,x[o+8],y,1770035416),w=h(w,t,u,v,x[o+9],z,2336552879),v=h(v,w,t,u,x[o+10],A,4294925233),u=h(u,v,w,t,x[o+11],B,2304563134),t=h(t,u,v,w,x[o+12],y,1804603682),w=h(w,t,u,v,x[o+13],z,4254626195),v=h(v,w,t,u,x[o+14],A,2792965006),u=h(u,v,w,t,x[o+15],B,1236535329),t=i(t,u,v,w,x[o+1],C,4129170786),w=i(w,t,u,v,x[o+6],D,3225465664),v=i(v,w,t,u,x[o+11],E,643717713),u=i(u,v,w,t,x[o+0],F,3921069994),t=i(t,u,v,w,x[o+5],C,3593408605),w=i(w,t,u,v,x[o+10],D,38016083),v=i(v,w,t,u,x[o+15],E,3634488961),u=i(u,v,w,t,x[o+4],F,3889429448),t=i(t,u,v,w,x[o+9],C,568446438),w=i(w,t,u,v,x[o+14],D,3275163606),v=i(v,w,t,u,x[o+3],E,4107603335),u=i(u,v,w,t,x[o+8],F,1163531501),t=i(t,u,v,w,x[o+13],C,2850285829),w=i(w,t,u,v,x[o+2],D,4243563512),v=i(v,w,t,u,x[o+7],E,1735328473),u=i(u,v,w,t,x[o+12],F,2368359562),t=j(t,u,v,w,x[o+5],G,4294588738),w=j(w,t,u,v,x[o+8],H,2272392833),v=j(v,w,t,u,x[o+11],I,1839030562),u=j(u,v,w,t,x[o+14],J,4259657740),t=j(t,u,v,w,x[o+1],G,2763975236),w=j(w,t,u,v,x[o+4],H,1272893353),v=j(v,w,t,u,x[o+7],I,4139469664),u=j(u,v,w,t,x[o+10],J,3200236656),t=j(t,u,v,w,x[o+13],G,681279174),w=j(w,t,u,v,x[o+0],H,3936430074),v=j(v,w,t,u,x[o+3],I,3572445317),u=j(u,v,w,t,x[o+6],J,76029189),t=j(t,u,v,w,x[o+9],G,3654602809),w=j(w,t,u,v,x[o+12],H,3873151461),v=j(v,w,t,u,x[o+15],I,530742520),u=j(u,v,w,t,x[o+2],J,3299628645),t=k(t,u,v,w,x[o+0],K,4096336452),w=k(w,t,u,v,x[o+7],L,1126891415),v=k(v,w,t,u,x[o+14],M,2878612391),u=k(u,v,w,t,x[o+5],N,4237533241),t=k(t,u,v,w,x[o+12],K,1700485571),w=k(w,t,u,v,x[o+3],L,2399980690),v=k(v,w,t,u,x[o+10],M,4293915773),u=k(u,v,w,t,x[o+1],N,2240044497),t=k(t,u,v,w,x[o+8],K,1873313359),w=k(w,t,u,v,x[o+15],L,4264355552),v=k(v,w,t,u,x[o+6],M,2734768916),u=k(u,v,w,t,x[o+13],N,1309151649),t=k(t,u,v,w,x[o+4],K,4149444226),w=k(w,t,u,v,x[o+11],L,3174756917),v=k(v,w,t,u,x[o+2],M,718787259),u=k(u,v,w,t,x[o+9],N,3951481745),t=c(t,p),u=c(u,q),v=c(v,r),w=c(w,s);var O=m(t)+m(u)+m(v)+m(w);return O.toLowerCase()},TimeOnSiteTracker.prototype.resetActivity=function(){this.activityStartTime=this.getDateTime(),this.activity.varyingStartTime=new Date,this.activity.totalTimeSpent=0,this.activity.totalTimeSpentArr=[]},TimeOnSiteTracker.prototype.startActivity=function(a){this.resetActivity(),this.activity.activityStarted=!0,a&&Object.keys(a).length&&(this.startActivityDetails=a),this.developerMode&&console.log("Activity starts at : "+this.activity.varyingStartTime)},TimeOnSiteTracker.prototype.endActivity=function(a,b){var c={};if(this.activity.activityStarted){console.log(this.activity.varyingStartTime);var d=new Date,e=0;this.activity.totalTimeSpentArr.length&&(this.activity.totalTimeSpent=this.arrayAggregate(this.activity.totalTimeSpentArr)),e=this.returnInSeconds?this.activity.totalTimeSpent+this.getTimeDiff(this.activity.varyingStartTime,d)/1e3:this.activity.totalTimeSpent+this.getTimeDiff(this.activity.varyingStartTime,d),this.developerMode&&(this.returnInSeconds?console.log("Total time spent : "+this.activity.totalTimeSpent+" in array: "+this.getTimeDiff(this.activity.varyingStartTime,d)/1e3):console.log("Total time spent : "+this.activity.totalTimeSpent+" in array: "+this.getTimeDiff(this.activity.varyingStartTime,d))),c=this.getPageData(),c.activityStart=this.activityStartTime,c.activityEnd=this.getDateTime(),c.timeTaken=Math.round(e),c.timeTakenTrackedBy=this.returnInSeconds===!0?"second":"millisecond",c.timeTakenByDuration=this.returnInSeconds===!0?this.secondToDuration(c.timeTaken):this.secondToDuration(this.millisecondToSecond(c.timeTaken));for(var f in this.startActivityDetails)c[f]=this.startActivityDetails[f];if(a&&Object.keys(a).length)for(var f in a)c[f]=a[f];c.trackingType="activity",this.activity.activityStarted=!1,this.resetActivity(),this.developerMode&&console.log("Activity ends at "+new Date),b||this.processActivityData(c)}else console.warn("Please start activity before finishing it!");return c},TimeOnSiteTracker.prototype.processActivityData=function(a){"function"==typeof this.callback?(a.realTimeTracking=!0,this.callback(a)):this.storeInLocalStorage&&this.saveToLocalStorage(a)},TimeOnSiteTracker.prototype.fileValidation=function(){var a="undefined";"undefined"!=typeof TimeOnSiteTracker&&(a="TimeOnSiteTracker"),this.getMD5Hash(a)!==this.fileIntegrityCode&&(this.developerMode=!1,this.isTimeOnSiteAllowed=!1,this.sessionStateChangeTimerId&&clearInterval(this.sessionStateChangeTimerId))},TimeOnSiteTracker.prototype.trackPageNavigation=function(){this.executeURLChangeCustoms()},TimeOnSiteTracker.prototype.saveToLocalStorage=function(a){if(this.storageSupported){var b,c=new Date,d=this.TOSDayKeyPrefix+(c.getMonth()+1)+"_"+c.getDate()+"_"+c.getFullYear(),e=!1,f=this.TOSDateKeysHolder;if(b=localStorage.getItem(f)){for(var g=JSON.parse(b),h=0;h<g.length;h++)if(g[h]==d){e=!0;break}e||(g.push(d),localStorage.setItem(f,JSON.stringify(g)))}else b=[],b.push(d),localStorage.setItem(f,JSON.stringify(b));var i=localStorage.getItem(d);if(i){var j=JSON.parse(i);j.push(a),localStorage.setItem(d,JSON.stringify(j))}else{var k=[];k.push(a),localStorage.setItem(d,JSON.stringify(k))}}else console.warn("Local storage not supported for TOS tracking!")},TimeOnSiteTracker.prototype.processDataInLocalStorage=function(){var a=this.getDateKeys();if(a instanceof Array&&a.length){var b=a[0];console.log("day key : "+b);var c=localStorage.getItem(b);if(c){var d=JSON.parse(c);d instanceof Array&&d.length&&this.sendData(b,d)}}},TimeOnSiteTracker.prototype.getDateKeys=function(){var a=[];if(this.storageSupported){var b=this.TOSDateKeysHolder,c=localStorage.getItem(b);c&&(a=JSON.parse(c))}return a},TimeOnSiteTracker.prototype.removeDateKey=function(a){var b=this.TOSDateKeysHolder,c=this.getDateKeys();if(this.storageSupported&&c instanceof Array&&c.length)for(var d=0;d<c.length;d++)c[d]==a&&(c.splice(d,1),localStorage.removeItem(a),localStorage.setItem(b,JSON.stringify(c)),c.length&&this.processDataInLocalStorage())},TimeOnSiteTracker.prototype.sendData=function(a,b){var c=this.request.url,d=JSON.stringify(b[0]),e=this;if(this.xhr=null,window.XMLHttpRequest?this.xhr=new XMLHttpRequest:this.xhr=new ActiveXObject("Microsoft.XMLHTTP"),this.xhr.open("POST",c,!1),this.xhr.setRequestHeader("Content-Type","application/json;charset=UTF-8"),this.isRequestHeadersAvailable&&this.request.headers.length)for(var f=0;f<this.request.headers.length;f++){var g=this.request.headers[f];for(var h in g)this.xhr.setRequestHeader(h,g[h])}this.xhr.onreadystatechange=function(){4==e.xhr.readyState&&200==e.xhr.status&&"success"==e.xhr.responseText&&(b.shift(),console.log("itemData.length is : "+b.length),b.length?(localStorage.setItem(a,JSON.stringify(b)),console.log("calling next item to process"),setTimeout(function(){e.sendData(a,b)},500)):(e.removeDateKey(a),e.xhr=null))},this.xhr.send(d)},TimeOnSiteTracker.prototype.cancelXMLHTTPRequest=function(){this.xhr&&"function"==typeof this.xhr.abort&&(this.developerMode&&(console.log(this.xhr),console.info("XHR request cancelled!")),this.xhr.abort())},TimeOnSiteTracker.prototype.bindWindowFocus=function(){var a,b,c,d=this;"undefined"!=typeof document.hidden?(a="hidden",c="visibilitychange",b="visibilityState"):"undefined"!=typeof document.mozHidden?(a="mozHidden",c="mozvisibilitychange",b="mozVisibilityState"):"undefined"!=typeof document.msHidden?(a="msHidden",c="msvisibilitychange",b="msVisibilityState"):"undefined"!=typeof document.webkitHidden&&(a="webkitHidden",c="webkitvisibilitychange",b="webkitVisibilityState"),"undefined"==typeof document.addEventListener||"undefined"==typeof a?console.log("Page visisbility API not supported in this browser which may result in less accuracy in TOS tracking!"):document.addEventListener(c,function(){if("visible"==document[b])d.varyingStartTime=new Date,d.totalTimeSpent=d.arrayAggregate(d.timeSpentArr),d.developerMode&&(console.log("On visible state"),console.log("Time spent on SITE so far : "+d.totalTimeSpent)),d.activity.activityStarted&&(d.activity.varyingStartTime=new Date,d.activity.totalTimeSpent=d.arrayAggregate(d.activity.totalTimeSpentArr),d.developerMode&&console.log("Time spent on ACTIVITY so far : "+d.activity.totalTimeSpent));else if("hidden"==document[b]){d.developerMode&&(console.log("On invisible state"),console.log(d.timeSpentArr));var a=new Date;d.returnInSeconds?d.timeSpentArr.push(d.getTimeDiff(d.varyingStartTime,a)/1e3):d.timeSpentArr.push(d.getTimeDiff(d.varyingStartTime,a)),d.activity.activityStarted&&(console.log(d.activity.totalTimeSpentArr),d.returnInSeconds?d.activity.totalTimeSpentArr.push(d.getTimeDiff(d.activity.varyingStartTime,a)/1e3):d.activity.totalTimeSpentArr.push(d.getTimeDiff(d.activity.varyingStartTime,a)))}d.developerMode&&console.log('Tracked by "SECONDS": '+d.returnInSeconds)},!1)},TimeOnSiteTracker.prototype.setCookie=function(a,b,c){var d,e,f=new Date;f.setTime(f.getTime()+1e3*c),d="expires="+f.toUTCString(),e=a+"="+b+"; "+d+"; "+this.TOSCookie.customCookieString,document.cookie=e},TimeOnSiteTracker.prototype.getCookie=function(a){var b,c=document.cookie.split(";");b=a+"=";for(var d=0;d<c.length;d++){for(var e=c[d];" "==e.charAt(0);)e=e.substring(1);if(0==e.indexOf(b))return e.substring(b.length,e.length)}return""},TimeOnSiteTracker.prototype.removeCookie=function(a){this.getCookie(a)&&(document.cookie=a+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; "+this.TOSCookie.customCookieString)},TimeOnSiteTracker.prototype.bindWindowHistory=function(){var a=this;if(window.history&&window.history.pushState)!function(a){var b=a.pushState;a.pushState=function(c){return"function"==typeof a.onpushstate&&a.onpushstate({state:c}),b.apply(a,arguments)}}(window.history),window.onpopstate=history.onpushstate=function(b){setTimeout(function(){a.developerMode&&console.info("URL changes via window history object!!!"),a.executeURLChangeCustoms()},100)};else{var b=function(){this.oldHash=window.location.hash;var b=this,c=function(){b.oldHash!=window.location.hash&&(b.oldHash=window.location.hash,a.developerMode&&console.info("URL changes via location.hash!!!"),a.executeURLChangeCustoms())};setInterval(function(){c()},100)};new b}},TimeOnSiteTracker.prototype.executeURLChangeCustoms=function(){this.monitorSession(),this.processTOSData(),this.initBlacklistUrlConfig(this.config)},TimeOnSiteTracker.prototype.bindWindowUnload=function(){var a=this,b=window.attachEvent||window.addEventListener,c=window.attachEvent?"onbeforeunload":"beforeunload";b(c,function(b){"undefied"==typeof b&&(b=window.event),b&&(a.monitorSession(),a.processTOSData(),a.cancelXMLHTTPRequest())})},TimeOnSiteTracker.prototype.processTOSData=function(){this.developerMode&&(console.log("Time at exit: "+new Date),console.log("Time so far : "+this.totalTimeSpent));var a=this.getTimeOnPage();a.exitTime=this.getDateTime(),this.isTimeOnSiteAllowed&&("function"==typeof this.callback?(a.realTimeTracking=!0,this.callback(a)):this.storeInLocalStorage&&this.saveToLocalStorage(a)),this.varyingStartTime=new Date,this.pageEntryTime=this.getDateTime(),this.totalTimeSpent=0,this.timeSpentArr=[],this.activity.activityStarted&&(this.activity.activityStarted=!1,this.resetActivity())};