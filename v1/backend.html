<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>TimeonsiteTracker (TOS) || Saving TOS to database</title>
    <meta name="description" content="TOS backend examples, server-side examples, examples with NodeJs and PHP, TimeOnSite tracking examples">
    <meta name="keywords" content="Saving TOS to database, backend examples, server-side examples">
    <meta name="robot" content="index,follow">
    <title>TimeonsiteTracker (TOS) - Saving TOS to database</title>

    <link rel="stylesheet" href="../stylesheets/styles.css">
    <link rel="stylesheet" href="../stylesheets/github-light.css">

    <link rel="stylesheet" href="../stylesheets/custom.css">
    <link rel="stylesheet" href="../stylesheets/sunburst.css">
    <meta name="viewport" content="width=device-width">


    <!-- timeonsitetracker -->
    <script src="../javascripts/timeonsitetracker.js"></script>
    <script src="../javascripts/tos_init.js"></script>
    
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
    <body>
        <div class="wrapper">
            <header>
                <h1>TimeonsiteTracker (TOS) - Saving TOS to database</h1>
                <p></p>

                <p class="view"><a href="https://github.com/saleemkce/timeonsite">View the Project on GitHub <small>saleemkce/timeonsite</small></a></p>

                <p><a href="index.html">v1.0.0</a></p>

                <p>
                    <a href="#NodeJs">NodeJs</a><br/>
                    <a href="#PHP">PHP</a><br/>
                    <a href ="#testing-with-postman">HTTP Request with Postman client</a>
                </p>


                <ul>
                  <li><a href="https://github.com/saleemkce/timeonsite/zipball/master">Download <strong>ZIP File</strong></a></li>
                  <li><a href="https://github.com/saleemkce/timeonsite/tarball/master">Download <strong>TAR Ball</strong></a></li>
                  <li><a href="https://github.com/saleemkce/timeonsite">View On <strong>GitHub</strong></a></li>
                </ul>
            </header>

            <section class="coverImg">
                <div class="text">
                    Time On Site Tracker
                </div>
              </section>

            <section>
            
                <!-- <h3><a id="welcome-to-github-pages" class="anchor" href="#welcome-to-github-pages" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Welcome to GitHub Pages.</h3>

                <p>This automatic page generator is the easiest way to create beautiful pages for all of your projects. Author your page content here <a href="https://guides.github.com/features/mastering-markdown/">using GitHub Flavored Markdown</a>, select a template crafted by a designer, and publish. After your page is generated, you can check out the new <code>gh-pages</code> branch locally. If you’re using GitHub Desktop, simply sync your repository and you’ll see the new branch.</p> -->



                <br/><h3 id="examples">Saving TOS to database - Examples || Server-side data handling</h3>
                <h3 id="time-on-site-tracking">Time On Site Tracking</h3>
                <h3 id="NodeJs">Node.js example</h3>
<pre class="prettyprint lang-js">
//file 1: tos.route.js
var controller = require('tos.controller.js')

module.exports = function(app) {

    app.route('/tos')
        .post(controller.SaveTos);
};



//file 2: tos.model.js
var mongoose = require('mongoose'),
Schema = new mongoose.Schema({
    TOSId: Number,
    TOSSessionKey: String,
    title: String,
    URL: String,
    currentTime: Date,
    entryTime: Date,
    exitTime: Date,
    timeOnPage: Number,
    timeOnPageTrackedBy: String,
    timeOnSite: Number
}, {
    versionKey: false,
    strict: false
});

var TosSchema = mongoose.model('tos', Schema);
module.exports = TosSchema;



//file 3: tos.controller.js
var TosSchema = require('tos.model.js');
var c = 0;
module.exports.SaveTos = function(req, res, next) {
    var data = req.body;
    console.log(data);

    if(data && data.trackingType && data.trackingType == 'tos') {
        var Tos = new TosSchema(data);
        // Data saved to mongoDB's tos collection
        Tos.save(data, function(err){
            console.log(err);
        });

        console.log('TOS type : ' + data.trackingType);
        console.log('Record No : ' + ++c);
    } else {
        console.log('TOS data not received. Please check your endpoint URL and POST data from client-side!');
    }

    res.send('success');
    
};
</pre>
                <p>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The example uses node's express framework to handle server-side data. We have three files here for saving data with node.js. A route file, a model file and a controller file.<br/><br/>
                * In route file, we create a route named "/tos" which is of POST method to accept data from incoming requests.
                <br/><br/>
                * In model file, we create new schema named "tos" which will save our TOS data. Since mongoDB is schema-free, we can save any number of fields in its collection. This is preferrable for collecting large number of custom data in TOS over RDBMS like MSSQL, MySql or Oracle.
                <br/><br/>
                * In controller file, we just check if there is data in "SaveTos" method. Then we load schema file and save our TOS data. By now, you might check your mongoDB collection to see if there is any data saved successfully.
                </p>


                <h3 id="PHP">PHP example</h3>
<pre class="prettyprint lang-sql">
// Create database named "test". Then, create table in any RDBMS (this example was tested in mysql DB) as follows:

CREATE TABLE tos(id INT AUTO_INCREMENT,
    tos_id BIGINT(20),
    tos_session_key VARCHAR(50),
    url VARCHAR(10000),
    title VARCHAR(5000),
    entry_time datetime,
    exit_time datetime,
    timeonpage INT,
    timeonpage_tracked_by VARCHAR(15),
    timeonsite INT,
    tracking_type VARCHAR(15),
    realtime_tracking BOOLEAN NOT NULL DEFAULT 0,
    transferred_with VARCHAR(15) NULL,
    PRIMARY KEY ( id )) CHARACTER SET utf8 COLLATE utf8_general_ci
</pre><br/>
<pre class="prettyprint lang-php">
<xmp>
//In PHP, create file: tos.php
<?php
if($_SERVER['REQUEST_METHOD'] == 'POST') {

    $data = json_decode(file_get_contents("php://input"));
    //print_r($data);

    // Mysql DB credentials
    $host = "localhost";
    $user = "root";
    $password = "";
    $database = "test";

    $con = mysqli_connect($host, $user, $password, $database);
    // Check connection
    if (mysqli_connect_errno())
    {
        echo "Failed to connect to MySQL: " . mysqli_connect_error();
    }

    // Perform queries
    $qry = "INSERT INTO tos (tos_id, tos_session_key, url, title, entry_time, exit_time, timeonpage, timeonpage_tracked_by, timeonsite, tracking_type, realtime_tracking, transferred_with) VALUES (".$data->TOSId.", '".$data->TOSSessionKey."', '".$data->URL."', '".$data->title."', '".$data->entryTime."', '".$data->exitTime."', ".$data->timeOnPage.", '".$data->timeOnPageTrackedBy."', ".$data->timeOnSite.", '".$data->trackingType."', ".$data->realTimeTracking.", '".$data->trasferredWith."')";
    //echo $qry;
    $res = mysqli_query($con, $qry);

    mysqli_close($con);
    if($res) {
        echo 'success';
    } else {
        echo 'error';
    }
} else {
    echo 'TOS data not received. Please check your endpoint URL and POST data from client-side!';
}
</xmp>
</pre>

                <p>
                * We form the required SQL query for saving our data in MySql or any other RDBMS of your preference. Create a database named "test". Then execute the given query to create new table named "tos".<br/><br/>
                * Create a new file named "tos.php" which checks if there is any incoming request with POST data. In case of valid data, it saves the data to "tos" table in database we just created. Do not forget to start your server (Apache, nginx etc.) that runs PHP while working out this example. Since saving data in RDBMS is schema-based and type checking is strict, you need to be careful in defining the fields while creating the table given above. In case of adding custom data or additional data in future, you need to modify schema and verify thoroughly to avoid query failure or data loss.
                </p>




                <h3 id="activity-tracking-NodeJs">Activity Tracking - NodeJs</h3>
<pre class="prettyprint lang-js">
//file 1: activity.route.js
var controller = require('activity.controller.js')

module.exports = function(app) {

    app.route('/activity')
        .post(controller.SaveActivity);
};



//file 2: activity.model.js
var mongoose = require('mongoose'),
Schema = new mongoose.Schema({ 
// we don't specify any fields here since mongo is schema-free. If you want to 
// specify fields with data type, you could do that. It applies to tos.model.js 
// file too which we created in this page.
}, {
    versionKey: false,
    strict: false
});

var ActivitySchema = mongoose.model('activity', Schema);
module.exports = ActivitySchema;



//file 3: activity.controller.js
var ActivitySchema = require('activity.model.js');
var c = 0;
module.exports.SaveActivity = function(req, res, next) {
    var data = req.body;
    console.log(data);

    if(data && data.trackingType && data.trackingType == 'activity') {
        var Activity = new ActivitySchema(data);
        // Data saved to mongoDB's tos collection
        Activity.save(data, function(err){
            console.log(err);
        });

        console.log('TOS type : ' + data.trackingType);
        console.log('Record No : ' + ++c);
    } else {
        console.log('TOS activity data not received. Please check your endpoint URL and POST data from client-side!');
    }

    res.send('success');
    
};
</pre>
                <p>
                    This code is self-explanatory. Create route, model and controller files for tracking activity. In controller, check if received data is of type "activity" if(data.trackingType == 'activity').  Save it to activities collection. You are done!
                </p>


<h3 id="activity-tracking-PHP">Activity Tracking - PHP</h3>
<pre class="prettyprint lang-sql">
// Create database named "test". Then, create table in any RDBMS (this example was tested in mysql DB) as follows:

CREATE TABLE activity(id INT AUTO_INCREMENT,
    tos_id BIGINT(20),
    tos_session_key VARCHAR(50),
    url VARCHAR(10000),
    title VARCHAR(5000),
    activity_duration INT,
    activity_duration_tracked_by VARCHAR(15),
    activity_start DATETIME,
    activity_end DATETIME,
    tracking_type VARCHAR(15),
    realtime_tracking BOOLEAN NOT NULL DEFAULT 0,
    transferred_with VARCHAR(15) NULL,
    PRIMARY KEY ( id )) CHARACTER SET utf8 COLLATE utf8_general_ci
</pre><br/>

<pre class="prettyprint lang-php">
<xmp>
//In PHP, create file: activity.php
<?php
if($_SERVER['REQUEST_METHOD'] == 'POST') {

    $data = json_decode(file_get_contents("php://input"));
    //print_r($data);

    // Mysql DB credentials
    $host = "localhost";
    $user = "root";
    $password = "";
    $database = "test";

    $con = mysqli_connect($host, $user, $password, $database);
    // Check connection
    if (mysqli_connect_errno())
    {
        echo "Failed to connect to MySQL: " . mysqli_connect_error();
    }

    // Perform queries
    $qry = "INSERT INTO activity (tos_id, tos_session_key, url, title, activity_duration, activity_duration_tracked_by, activity_start, activity_end, tracking_type, realtime_tracking, transferred_with) VALUES (".$data->TOSId.", '".$data->TOSSessionKey."', '".$data->URL."', '".$data->title."', ".$data->activityDuration.", '".$data->activityDurationTrackedBy."', '".$data->activityStart."', '".$data->activityEnd."', '".$data->trackingType."', ".$data->realTimeTracking.", '".$data->trasferredWith."')";
    //echo $qry;
    $res = mysqli_query($con, $qry);

    mysqli_close($con);
    if($res) {
        echo 'success';
    } else {
        echo 'error';
    }
} else {
    echo 'No data received!';
}
</xmp>
</pre>


                <h3 id="testing-with-postman">Test with Postman</h3>
<pre class="prettyprint">
URL: http://localhost/project-z/examples/tos.php  //give URL where your server-side tos.php file resides/NodeJs route to handle tos data.

Method: POST

Type: application/json

// In request body,
Body:
{
    "TOSId" : 32305137576,
    "TOSSessionKey" : "14807574018248237618",
    "URL" : "http://tos-localdata.chennai/home",
    "title" : "Home page - testing TOS!",
    "entryTime" : "2016-11-23T16:42:22.766Z",
    "currentTime" : "2016-11-23T16:42:44.189Z",
    "timeOnPage" : 21,
    "timeOnPageTrackedBy" : "second",
    "timeOnSite" : 1359,
    "trackingType" : "tos",
    "exitTime" : "2016-11-23T16:42:44.189Z",
    "realTimeTracking" : true,
    "trasferredWith" : "sendBecon"
}
</pre>
                <p>In HTTP client like Postman, you could test if your route works before applying the code in your application.</p>



            </section>
            <footer>
                <p>This project is maintained by <a href="https://github.com/saleemkce">saleemkce</a></p>
                <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
            </footer>
        </div>
        <script src="../javascripts/scale.fix.js"></script>
        <script src="../javascripts/run_prettify.js"></script>
    </body>
</html>
<!-- 
html code conversion @
http://www.web2generators.com/html-based-tools/online-html-entities-encoder-and-decoder 
-->
